name: Auto-Patch PR
on:
  push:
    branches: [ patch ]
  pull_request:
    branches: [ patch ]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Run Linting
        run: npm run lint

      - name: Run Tests
        run: npm test

      - name: Build Application
        run: npm run build

      - name: Test Docker Build
        run: docker compose build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Claude Auto-Patch: ${{ github.sha }}'
          title: 'ü§ñ Auto-Patch: Requires Approval'
          body: |
            ## Claude Auto-Patch Generated

            This patch was automatically generated by Claude MCP and requires human review and approval.

            ### Changes Summary
            - Generated from commit: ${{ github.sha }}
            - Created at: ${{ github.event.head_commit.timestamp }}
            - Author: ${{ github.event.head_commit.author.name }}

            ### Automated Checks ‚úÖ
            - [x] Linting passed
            - [x] Tests passed
            - [x] Build successful
            - [x] Docker build verified

            ### Required Actions
            - [ ] Review code changes
            - [ ] Verify patch logic
            - [ ] Test in staging environment
            - [ ] Approve and merge

            ### Emergency Override
            If this is an emergency, use the `/force-merge` command in a comment.

            ---
            *This PR was automatically generated by the Claude Auto-Patch system.*
          base: main
          branch: patch-${{ github.sha }}
          delete-branch: true
          labels: |
            auto-patch
            needs-review
            claude-generated
          assignees: ${{ github.repository_owner }}

      - name: Request Reviewers
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              reviewers: ['${{ github.repository_owner }}']
            });

      - name: Add PR Comment
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            const comment = `
            ## üîç Patch Review Checklist

            Please review this auto-generated patch:

            ### Security Checks
            - [ ] No sensitive data exposed
            - [ ] No hardcoded secrets
            - [ ] Input validation present
            - [ ] Authentication/authorization intact

            ### Code Quality
            - [ ] Code follows project standards
            - [ ] Error handling implemented
            - [ ] Logging appropriate
            - [ ] Tests cover changes

            ### Functional Review
            - [ ] Patch addresses root cause
            - [ ] No breaking changes introduced
            - [ ] Performance impact acceptable
            - [ ] Backward compatibility maintained

            ### Deployment
            - [ ] Staging environment tested
            - [ ] Rollback plan ready
            - [ ] Monitoring/alerting updated

            Use ‚úÖ or ‚ùå to indicate completion.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });