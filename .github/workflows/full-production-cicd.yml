name: üöÄ Full Production CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_ENV: production
  DOCKER_BUILDKIT: 1

jobs:
  build-test-deploy:
    name: üß© Build, Test & Deploy
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Repository
      - name: üßæ Checkout Code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3Ô∏è‚É£ Install Dependencies
      - name: üì¶ Install Dependencies
        run: |
          npm ci --legacy-peer-deps
          cd frontend && npm ci --legacy-peer-deps && cd ..

      # 4Ô∏è‚É£ Run Lint & Type Checks
      - name: üîç Lint & Type Check
        run: |
          npm run lint || echo "‚ö†Ô∏è Lint warnings only"
          npm run type-check || echo "‚ö†Ô∏è Type warnings only"

      # 5Ô∏è‚É£ Run Unit Tests
      - name: üß™ Run Tests
        run: npm test --if-present

      # 6Ô∏è‚É£ Build Docker Services
      - name: üê≥ Build Docker Images
        run: docker compose -f docker-compose.prod.yml build

      # 7Ô∏è‚É£ Health Check (before deploy)
      - name: üíä Pre-Deploy Health Check
        run: |
          echo "Performing pre-deploy health check..."
          docker compose -f docker-compose.prod.yml up -d
          sleep 10
          curl -fsS http://localhost:8080/health || exit 1
          docker compose down

      # 8Ô∏è‚É£ Run Full Production Deployment
      - name: üöÄ Run Full Deployment Script
        run: bash ./deploy_full_production.sh
        env:
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          API_KEY: ${{ secrets.API_KEY }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          RAG_API_URL: ${{ secrets.RAG_API_URL }}
          DOCLING_API_URL: ${{ secrets.DOCLING_API_URL }}
          BUILDER_API_KEY: ${{ secrets.BUILDER_API_KEY }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
          PAGERDUTY_ROUTING_KEY: ${{ secrets.PAGERDUTY_ROUTING_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ secrets.GITHUB_REPO }}

      # 9Ô∏è‚É£ Post-Deployment Health Verification
      - name: ü©∫ Post-Deployment Health Check
        run: |
          echo "Verifying deployment..."
          curl -fsS https://your-production-domain.com/health || exit 1
          echo "‚úÖ Deployment verified successfully."

      # üîü Notify Success
      - name: üéâ Send Success Alerts
        if: success()
        run: |
          curl -X POST -H "Content-type: application/json" \
          --data '{"text":"‚úÖ Original Oak Carpentry production deployment completed successfully!"}' \
          $SLACK_WEBHOOK_URL
          curl -X POST https://events.pagerduty.com/v2/enqueue \
          -H "Content-Type: application/json" \
          -d "{\"routing_key\":\"$PAGERDUTY_ROUTING_KEY\",\"event_action\":\"trigger\",\"payload\":{\"summary\":\"‚úÖ Deployment Success - Original Oak Carpentry MCP\",\"severity\":\"info\",\"source\":\"GitHub Actions\"}}"

      # üîÅ Rollback on Failure
      - name: ‚ö†Ô∏è Rollback if Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed. Rolling back..."
          git revert HEAD --no-edit
          git push origin main
          curl -X POST -H "Content-type: application/json" \
          --data '{"text":"üö® Deployment failed and rollback executed!"}' \
          $SLACK_WEBHOOK_URL
          curl -X POST https://events.pagerduty.com/v2/enqueue \
          -H "Content-Type: application/json" \
          -d "{\"routing_key\":\"$PAGERDUTY_ROUTING_KEY\",\"event_action\":\"trigger\",\"payload\":{\"summary\":\"üö® Deployment Failure - Rollback Executed\",\"severity\":\"error\",\"source\":\"GitHub Actions\"}}"