name: ğŸš€ Full Production CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_ENV: production

jobs:
  build-test-deploy:
    name: ğŸ§© Build, Test & Deploy
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout Repository
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3ï¸âƒ£ Install Dependencies
      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      # 4ï¸âƒ£ Run Tests
      - name: ğŸ§ª Run Tests
        run: npm test

      # 5ï¸âƒ£ Run Lint & Type Checks
      - name: ğŸ” Lint & Type Check
        run: |
          npm run lint
          npm run type-check

      # 6ï¸âƒ£ Build Next.js Application
      - name: ğŸ—ï¸ Build Application
        run: npm run build

      # 7ï¸âƒ£ Verify Build Output
      - name: âœ… Verify Build
        run: |
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed - .next directory not found"
            exit 1
          fi
          echo "âœ… Build completed successfully"
          echo "ğŸ“Š Build size:"
          du -sh .next

      # 8ï¸âƒ£ Success Notification
      - name: ğŸ‰ Build Success
        if: success()
        run: |
          echo "âœ… Original Oak Carpentry build completed successfully!"
          echo "ğŸš€ Ready for deployment"

      # 9ï¸âƒ£ Failure Notification
      - name: âŒ Build Failed
        if: failure()
        run: |
          echo "âŒ Build failed. Please check the logs above."
          exit 1